# BUG-045: オーバーレイDLボタンが残る問題

**作成日**: 2025-11-14
**ステータス**: ✅ 修正完了
**優先度**: High
**カテゴリ**: UI/UX

---

## 📋 問題の概要

9animeなどでカスタムプレーヤーを閉じた後、画面左下にオーバーレイDLボタンだけが残る問題。

## 🔍 再現手順

1. 9animeにアクセス
2. 動画を再生（カスタムプレーヤーが起動）
3. カスタムプレーヤーを閉じる
4. **問題**: 画面左下にDLボタンだけが残る

## 🐛 原因

### コード箇所
- ファイル: `BrowserView.swift`
- 行: 192-223（削除前）

### 問題のコード
```swift
// 動画再生中のDLボタン（オーバーレイ） - フルスクリーン対策で常に最前面
if viewModel.hasVideo {
    VStack {
        Spacer()
        HStack {
            Button(action: {
                // ダウンロード処理
            }) {
                Image(systemName: "arrow.down.circle.fill")
                    .font(.system(size: 32))
                    .foregroundColor(.white)
                    .background(
                        Circle()
                            .fill(Color.black.opacity(0.6))
                            .frame(width: 50, height: 50)
                    )
            }
            .padding(.leading, 20)
            .padding(.bottom, 100)
            .zIndex(999)

            Spacer()
        }
    }
    .allowsHitTesting(true)
    .zIndex(999)
}
```

### 根本原因

1. **`hasVideo`フラグの管理不良**
   - 動画検出時に`hasVideo = true`になる
   - カスタムプレーヤー起動後、`videoStopped`が発火しない
   - `hasVideo`が`true`のまま残る
   - オーバーレイDLボタンが表示され続ける

2. **設計上の問題**
   - このオーバーレイボタンはFEATURE-011（失敗）の名残
   - フルスクリーン動画でメニューが出せない時の救済策として追加
   - しかし9animeではカスタムプレーヤーが起動するため不要
   - 本来は動画長押しメニューでダウンロードすべき

3. **機能していない**
   - 9animeではカスタムプレーヤーが起動し、そこでは再生できない
   - オーバーレイボタンは誤動作の元
   - ユーザーにとって混乱を招く

## ✅ 修正内容

### 実施した対応

**オーバーレイDLボタンを完全に削除**（BrowserView.swift 192-223行）

### 理由

1. **不要な機能**: 動画ダウンロードは長押しメニューで十分
2. **誤動作**: カスタムプレーヤー後にボタンが残る
3. **ユーザー混乱**: 意味不明なボタンが表示される
4. **失敗した実装の名残**: FEATURE-011で追加されたが失敗

### 正しいダウンロード方法

- **動画長押し** → メニューから「動画をダウンロード」

## 📚 再発防止策

### dev.mdに記載のルール確認

✅ **バグ発見時のフロー**（dev.md 51-57行）
1. 起票: `docs/04-improvements/BUG-XXX-description.md`作成
2. ブランチ: `develop`で作業
3. 修正: コード修正実装
4. ドキュメント更新: チケットに修正内容記載
5. 動作確認待ち: ステータスを「要確認」に
6. OK確認後: コミット&プッシュ（**ユーザー確認必須**）

### 今後の対策

1. **検証コードの削除徹底**
   - 失敗した実装は即座に削除
   - 「後で使うかも」は禁止
   - 残すとバグの元になる

2. **コードレビュー強化**
   - 使われていないコードがないか定期チェック
   - 特にUI要素は目立つため厳しくチェック

3. **フラグ管理の見直し**
   - `hasVideo`のような状態フラグは慎重に管理
   - 必ずリセット処理を実装する

4. **機能追加時の慎重さ**
   - 新機能追加時は必ず削除方法も考える
   - 失敗時の切り戻しプランを用意

## 🔗 関連

- [FEATURE-011-FINAL-SUMMARY.md](FEATURE-011-FINAL-SUMMARY.md) - 失敗した実装の記録
- [dev.md](../../dev.md) - 開発ルール

---

**修正完了日**: 2025-11-14
**修正者**: Claude Code
**動作確認**: 要確認
