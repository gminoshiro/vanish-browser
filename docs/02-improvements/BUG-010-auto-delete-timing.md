# BUG-010: 自動削除のタイミングが正しく動作しない

🟠 P1 High | 📝 未着手

---

## 問題

現在の実装では、アプリ起動時からのTimerで削除を実行しているため、「最終起動から指定時間経過後に削除」という仕様が実現できていない。

### 現在の挙動
- 24h設定でアプリ起動 → 起動中に24h経過したら削除
- アプリを閉じるとTimerが停止し、削除されない

### 期待される挙動
- 2025/10/15 22:00にアプリを最後に開いた
- 2025/10/16 22:00には自動削除が実行される（アプリが起動していなくても）

---

## 技術的課題

### 1. 最終起動時刻の追跡
- アプリがフォアグラウンドからバックグラウンドに移行した時刻を保存
- 次回起動時に経過時間をチェック

### 2. バックグラウンドでの削除実行
- iOSはバックグラウンドタスクに制限あり
- BGTaskScheduler（最大30秒、確実性なし）
- 次回起動時に削除を実行する方式が現実的

### 3. バックグラウンド起動の判定
**検討中**: アプリがバックグラウンドで起動している状態を「開いていない」と判定するか？
- `UIApplication.willResignActiveNotification` - バックグラウンド移行時
- `UIApplication.didBecomeActiveNotification` - フォアグラウンド復帰時

---

## 実装方針（案）

### 案1: 次回起動時に削除（推奨）
1. `willResignActive`で最終起動時刻をUserDefaultsに保存
2. アプリ起動時（`didBecomeActive`）に経過時間をチェック
3. 指定時間を超えていたら削除実行
4. バックグラウンドタスクは使用しない（確実性のため）

### 案2: BGTaskSchedulerを併用
1. 案1に加えて、BGTaskSchedulerで定期チェック
2. ただしiOSの制限により実行保証なし
3. 次回起動時のチェックが最終防衛線

---

## 仕様確認事項

- [ ] バックグラウンド起動中は「開いていない」判定でよいか？
- [ ] 次回起動時の削除で仕様を満たせるか？
- [ ] 削除タイミングのユーザー通知は必要か？

---

## テスト方法

1. **5分設定でテスト**
   - 自動削除を5分に設定
   - アプリを閉じて5分待つ
   - アプリを開いて削除されているか確認

2. **UserDefaults操作テスト**
   - 最終起動時刻を手動で過去に設定
   - アプリを開いて削除が実行されるか確認

3. **実機テスト**
   - シミュレータでは動作が異なる可能性
   - 実機で24h設定をテスト

---

## 関連ファイル

- [AutoDeleteService.swift](../../VanishBrowser/VanishBrowser/Services/AutoDeleteService.swift) (121-136行目: scheduleAutoDelete)
- [VanishBrowserApp.swift](../../VanishBrowser/VanishBrowser/VanishBrowserApp.swift)

---

## 関連ドキュメント

自動削除の仕様については[プロダクトコンセプト](../02-product/product-concept.md#自動削除機能)を参照。
