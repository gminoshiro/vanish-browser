//
//  CustomVideoPlayerView.swift
//  VanishBrowser
//
//  Created by Á∞ëÂüéÁéÑÂ§™ on 2025/10/12.
//

import SwiftUI
import AVKit
import Combine

struct CustomVideoPlayerView: View {
    let videoURL: URL
    let videoFileName: String
    let showDownloadButton: Bool  // DL„Éú„Çø„É≥„ÅÆË°®Á§∫/ÈùûË°®Á§∫
    @Binding var isPresented: Bool
    @StateObject private var playerViewModel: VideoPlayerViewModel
    @State private var showControls = true
    @State private var hideControlsTask: Task<Void, Never>?
    @State private var showDownloadDialog = false
    @State private var showShareSheet = false

    init(videoURL: URL, videoFileName: String, showDownloadButton: Bool = true, isPresented: Binding<Bool>) {
        print("üé¨ CustomVideoPlayerViewÂàùÊúüÂåñ")
        print("üé¨ videoURL: \(videoURL.absoluteString)")
        print("üé¨ videoFileName: \(videoFileName)")
        print("üé¨ showDownloadButton: \(showDownloadButton)")
        print("üé¨ „Éï„Ç°„Ç§„É´Â≠òÂú®: \(FileManager.default.fileExists(atPath: videoURL.path))")

        self.videoURL = videoURL
        self.videoFileName = videoFileName
        self.showDownloadButton = showDownloadButton
        self._isPresented = isPresented
        self._playerViewModel = StateObject(wrappedValue: VideoPlayerViewModel(url: videoURL))
    }

    var body: some View {
        GeometryReader { geometry in
            ZStack {
                Color.black.ignoresSafeArea()

                // „Ç´„Çπ„Çø„É†„Éì„Éá„Ç™„Éó„É¨„Éº„É§„ÉºÔºàAVPlayerLayer„ÇíÁõ¥Êé•‰ΩøÁî®Ôºâ
                CustomAVPlayerView(player: playerViewModel.player)
                    .ignoresSafeArea()
                    .onTapGesture {
                        toggleControls()
                    }

                // „Ç´„Çπ„Çø„É†„Ç≥„É≥„Éà„É≠„Éº„É´
                if showControls {
                    VStack(spacing: 0) {
                        // ‰∏äÈÉ®: Èñâ„Åò„Çã„Éú„Çø„É≥ÔºàÂ∑¶‰∏äÔºâ„Å®ÂÖ±Êúâ„Éú„Çø„É≥ÔºàÂè≥‰∏ä„ÄÅDLÊ∏à„Åø„ÅÆ„ÅøÔºâ
                        HStack {
                            // Â∑¶‰∏ä: √ó„Éú„Çø„É≥
                            Button(action: {
                                isPresented = false
                            }) {
                                Image(systemName: "xmark.circle.fill")
                                    .font(.system(size: 32))
                                    .foregroundColor(.white)
                            }

                            Spacer()

                            // Âè≥‰∏ä: ÂÖ±Êúâ„Éú„Çø„É≥ÔºàDLÊ∏à„ÅøÂãïÁîª„ÅÆ„ÅøË°®Á§∫Ôºâ
                            if !showDownloadButton {  // DLÊ∏à„ÅøÂãïÁîªÔºàshowDownloadButton=false„ÅÆÂ†¥ÂêàÔºâ
                                Button(action: {
                                    showShareSheet = true
                                }) {
                                    Image(systemName: "square.and.arrow.up")
                                        .font(.system(size: 28))
                                        .foregroundColor(.white)
                                }
                            }
                        }
                        .padding(.horizontal, 20)
                        .padding(.top, max(geometry.safeAreaInsets.top, 16))
                        .padding(.bottom, 16)
                        .background(
                            LinearGradient(
                                gradient: Gradient(colors: [Color.black.opacity(0.7), Color.clear]),
                                startPoint: .top,
                                endPoint: .bottom
                            )
                        )

                        Spacer()

                        // ‰∏ãÈÉ®: ÂÜçÁîü„Ç≥„É≥„Éà„É≠„Éº„É´
                        VStack(spacing: 12) {
                            // „Ç∑„Éº„ÇØ„Éê„Éº
                            HStack(spacing: 8) {
                                Text(formatTime(playerViewModel.currentTime))
                                    .foregroundColor(.white)
                                    .font(.caption)
                                    .monospacedDigit()

                                Slider(
                                    value: Binding(
                                        get: { playerViewModel.currentTime },
                                        set: { playerViewModel.seek(to: $0) }
                                    ),
                                    in: 0...max(playerViewModel.duration, 1)
                                )
                                .accentColor(.white)

                                Text(formatTime(playerViewModel.duration))
                                    .foregroundColor(.white)
                                    .font(.caption)
                                    .monospacedDigit()
                            }
                            .padding(.horizontal, 20)

                            // ÂÜçÁîü„Éú„Çø„É≥„Å®„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Éú„Çø„É≥
                            HStack(spacing: 24) {
                                // „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ„Éú„Çø„É≥ÔºàDLÂâç„ÅÆ„ÅøË°®Á§∫Ôºâ
                                if showDownloadButton {
                                    Button(action: {
                                        print("üì• DL„Éú„Çø„É≥Êäº‰∏ã: \(videoFileName)")
                                        print("üì• URL: \(videoURL.absoluteString)")
                                        // „Éó„É¨„Éº„É§„Éº„ÇíÈñâ„Åò„Åö„Å´„ÉÄ„Ç§„Ç¢„É≠„Ç∞„ÇíË°®Á§∫
                                        playerViewModel.pause()
                                        showDownloadDialog = true
                                    }) {
                                        Image(systemName: "arrow.down.circle.fill")
                                            .font(.system(size: 32))
                                            .foregroundColor(.white)
                                            .background(
                                                Circle()
                                                    .fill(Color.blue)
                                                    .frame(width: 36, height: 36)
                                            )
                                    }
                                }

                                Spacer()

                                // Â∑ª„ÅçÊàª„Åó„Éú„Çø„É≥
                                Button(action: {
                                    playerViewModel.skipBackward()
                                }) {
                                    Image(systemName: "gobackward.10")
                                        .font(.system(size: 32))
                                        .foregroundColor(.white)
                                }

                                // ÂÜçÁîü/‰∏ÄÊôÇÂÅúÊ≠¢„Éú„Çø„É≥
                                Button(action: {
                                    playerViewModel.togglePlayPause()
                                }) {
                                    Image(systemName: playerViewModel.isPlaying ? "pause.fill" : "play.fill")
                                        .font(.system(size: 36))
                                        .foregroundColor(.white)
                                }

                                // Êó©ÈÄÅ„Çä„Éú„Çø„É≥
                                Button(action: {
                                    playerViewModel.skipForward()
                                }) {
                                    Image(systemName: "goforward.10")
                                        .font(.system(size: 32))
                                        .foregroundColor(.white)
                                }

                                Spacer()

                                // „Åù„ÅÆ‰ªñ„É°„Éã„É•„Éº
                                Menu {
                                    Button(action: {
                                        playerViewModel.changeSpeed(0.5)
                                    }) {
                                        Label("0.5x", systemImage: "speedometer")
                                    }
                                    Button(action: {
                                        playerViewModel.changeSpeed(1.0)
                                    }) {
                                        Label("1.0x (Ê®ôÊ∫ñ)", systemImage: "speedometer")
                                    }
                                    Button(action: {
                                        playerViewModel.changeSpeed(1.5)
                                    }) {
                                        Label("1.5x", systemImage: "speedometer")
                                    }
                                    Button(action: {
                                        playerViewModel.changeSpeed(2.0)
                                    }) {
                                        Label("2.0x", systemImage: "speedometer")
                                    }
                                } label: {
                                    Image(systemName: "ellipsis")
                                        .font(.system(size: 24))
                                        .foregroundColor(.white)
                                        .frame(width: 36, height: 36)
                                }
                            }
                            .padding(.horizontal, 24)
                            .padding(.bottom, max(geometry.safeAreaInsets.bottom, 20))
                        }
                        .background(
                            LinearGradient(
                                gradient: Gradient(colors: [Color.clear, Color.black.opacity(0.7)]),
                                startPoint: .top,
                                endPoint: .bottom
                            )
                        )
                    }
                    .frame(width: geometry.size.width, height: geometry.size.height)
                    .transition(.opacity)
                }
            }
        }
        .onAppear {
            playerViewModel.play()
            scheduleHideControls()
        }
        .onDisappear {
            playerViewModel.pause()
        }
        .sheet(isPresented: $showDownloadDialog) {
            DownloadDialogView(
                fileName: .constant(videoFileName),
                videoURL: videoURL,
                onDownload: { fileName, folder in
                    // ÈÄöÂ∏∏„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                    DownloadManager.shared.startDownload(url: videoURL, fileName: fileName, folder: folder)
                    isPresented = false
                },
                onHLSDownload: { quality, format, fileName, folder in
                    // HLS„ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                    NotificationCenter.default.post(
                        name: NSNotification.Name("StartHLSDownload"),
                        object: nil,
                        userInfo: [
                            "quality": quality,
                            "format": format,
                            "fileName": fileName,
                            "folder": folder
                        ]
                    )
                    isPresented = false
                }
            )
        }
        .sheet(isPresented: $showShareSheet) {
            ShareSheet(items: [videoURL])
        }
    }

    private func toggleControls() {
        withAnimation {
            showControls.toggle()
        }
        if showControls {
            scheduleHideControls()
        }
    }

    private func scheduleHideControls() {
        hideControlsTask?.cancel()
        hideControlsTask = Task {
            try? await Task.sleep(nanoseconds: 3_000_000_000) // 3Áßí
            withAnimation {
                showControls = false
            }
        }
    }

    private func formatTime(_ seconds: Double) -> String {
        let minutes = Int(seconds) / 60
        let secs = Int(seconds) % 60
        return String(format: "%d:%02d", minutes, secs)
    }
}

// „Éì„Éá„Ç™„Éó„É¨„Éº„É§„Éº„ÅÆViewModel
class VideoPlayerViewModel: NSObject, ObservableObject {
    let player: AVPlayer
    @Published var currentTime: Double = 0
    @Published var duration: Double = 0
    @Published var isPlaying: Bool = false

    private var timeObserver: Any?

    init(url: URL) {
        print("üé• VideoPlayerViewModelÂàùÊúüÂåñ: \(url.absoluteString)")
        print("üé• „Éï„Ç°„Ç§„É´Â≠òÂú®Á¢∫Ë™ç: \(FileManager.default.fileExists(atPath: url.path))")

        self.player = AVPlayer(url: url)

        super.init()

        // AVPlayer„ÅÆ„Çπ„ÉÜ„Éº„Çø„ÇπÁõ£Ë¶ñ
        player.currentItem?.addObserver(self, forKeyPath: "status", options: [.new, .initial], context: nil)

        // ÂÜçÁîüÊôÇÈñì„ÅÆÁõ£Ë¶ñ
        timeObserver = player.addPeriodicTimeObserver(
            forInterval: CMTime(seconds: 0.5, preferredTimescale: 600),
            queue: .main
        ) { [weak self] time in
            self?.currentTime = time.seconds
        }

        // ÂãïÁîª„ÅÆÈï∑„Åï„ÇíÂèñÂæó
        player.currentItem?.asset.loadValuesAsynchronously(forKeys: ["duration"]) { [weak self] in
            DispatchQueue.main.async {
                if let duration = self?.player.currentItem?.asset.duration {
                    self?.duration = CMTimeGetSeconds(duration)
                    print("üé• ÂãïÁîª„ÅÆÈï∑„Åï: \(CMTimeGetSeconds(duration))Áßí")
                }
            }
        }

        // „Ç®„É©„ÉºÁõ£Ë¶ñ
        if let error = player.currentItem?.error {
            print("‚ùå AVPlayer„Ç®„É©„Éº: \(error.localizedDescription)")
        }

        // ÂÜçÁîüÁä∂ÊÖã„ÅÆÁõ£Ë¶ñ
        NotificationCenter.default.addObserver(
            forName: .AVPlayerItemDidPlayToEndTime,
            object: player.currentItem,
            queue: .main
        ) { [weak self] _ in
            self?.isPlaying = false
        }
    }

    override func observeValue(forKeyPath keyPath: String?, of object: Any?, change: [NSKeyValueChangeKey : Any]?, context: UnsafeMutableRawPointer?) {
        if keyPath == "status" {
            if let statusNumber = change?[.newKey] as? NSNumber {
                let status = AVPlayerItem.Status(rawValue: statusNumber.intValue)
                switch status {
                case .readyToPlay:
                    print("‚úÖ AVPlayer: ÂÜçÁîüÊ∫ñÂÇôÂÆå‰∫Ü")
                case .failed:
                    if let error = player.currentItem?.error {
                        print("‚ùå AVPlayer: ÂÜçÁîüÂ§±Êïó - \(error.localizedDescription)")
                    }
                case .unknown:
                    print("‚ö†Ô∏è AVPlayer: „Çπ„ÉÜ„Éº„Çø„Çπ‰∏çÊòé")
                default:
                    break
                }
            }
        }
    }

    deinit {
        player.currentItem?.removeObserver(self, forKeyPath: "status")
        if let timeObserver = timeObserver {
            player.removeTimeObserver(timeObserver)
        }
    }

    func play() {
        player.play()
        isPlaying = true
    }

    func pause() {
        player.pause()
        isPlaying = false
    }

    func togglePlayPause() {
        if isPlaying {
            pause()
        } else {
            play()
        }
    }

    func seek(to time: Double) {
        player.seek(to: CMTime(seconds: time, preferredTimescale: 600))
    }

    func skipForward() {
        let newTime = min(currentTime + 10, duration)
        seek(to: newTime)
    }

    func skipBackward() {
        let newTime = max(currentTime - 10, 0)
        seek(to: newTime)
    }

    func changeSpeed(_ rate: Float) {
        player.rate = rate
        if isPlaying {
            player.play()
        }
    }
}

// „Ç´„Çπ„Çø„É†AVPlayerViewÔºàAVPlayerLayer„ÇíÁõ¥Êé•‰ΩøÁî®„Åó„Å¶ViewController„ÇíÂõûÈÅøÔºâ
struct CustomAVPlayerView: UIViewRepresentable {
    let player: AVPlayer

    func makeUIView(context: Context) -> UIView {
        let view = PlayerUIView()
        view.playerLayer.player = player

        // Ê®ôÊ∫ñ„Éó„É¨„Éº„É§„Éº„ÅÆË°®Á§∫„ÇíÂÆåÂÖ®„Å´ÁÑ°ÂäπÂåñ
        view.playerLayer.videoGravity = .resizeAspect

        print("‚úÖ CustomAVPlayerView‰ΩúÊàêÂÆå‰∫ÜÔºàAVPlayerLayer„ÇíÁõ¥Êé•‰ΩøÁî®Ôºâ")
        return view
    }

    func updateUIView(_ uiView: UIView, context: Context) {
        // ÂøÖË¶Å„Å´Âøú„Åò„Å¶Êõ¥Êñ∞Âá¶ÁêÜ
    }

    // „Ç´„Çπ„Çø„É†UIViewÔºàAVPlayerLayer„ÇíÁõ¥Êé•‰øùÊåÅÔºâ
    class PlayerUIView: UIView {
        override class var layerClass: AnyClass {
            return AVPlayerLayer.self
        }

        var playerLayer: AVPlayerLayer {
            return layer as! AVPlayerLayer
        }
    }
}
